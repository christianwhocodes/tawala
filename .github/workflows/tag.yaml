name: Create Release Tag

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  create-tag:
    name: Create Release Tag
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Get package version
        id: get_version
        run: |
          VERSION=$(uv version --short)
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Package version: $VERSION"

      - name: Check version type
        id: check_version
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"

          if [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "TYPE=stable" >> $GITHUB_OUTPUT
            echo "Version type: stable"
          elif [[ "$VERSION" =~ (a)[0-9]* ]]; then
            echo "TYPE=alpha" >> $GITHUB_OUTPUT
            echo "Version type: alpha"
          elif [[ "$VERSION" =~ (b)[0-9]* ]]; then
            echo "TYPE=beta" >> $GITHUB_OUTPUT
            echo "Version type: beta"
          elif [[ "$VERSION" =~ (rc)[0-9]* ]]; then
            echo "TYPE=rc" >> $GITHUB_OUTPUT
            echo "Version type: release candidate"
          elif [[ "$VERSION" =~ (post)[0-9]* ]]; then
            echo "TYPE=post" >> $GITHUB_OUTPUT
            echo "Version type: post"
          elif [[ "$VERSION" =~ (dev)[0-9]* ]]; then
            echo "TYPE=dev" >> $GITHUB_OUTPUT
            echo "Version type: dev"
          else
            echo "TYPE=unknown" >> $GITHUB_OUTPUT
            echo "Version type: unknown"
          fi

      - name: Create and push git tag
        if: steps.check_version.outputs.TYPE != 'unknown'
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          if [[ "${{ steps.check_version.outputs.TYPE }}" == "stable" ]]; then
            TAG="$VERSION.stable"
          else
            TAG="$VERSION"
          fi

          if git ls-remote --tags origin | grep -q "$TAG"; then
            echo "Tag $TAG already exists on remote. Skipping."
          else
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git tag -a "$TAG" -m "Release version $TAG"
            git push origin "$TAG"
            echo "Created and pushed tag: $TAG"
          fi
