name: 2) Build and Publish

on:
  push:
    tags:
      - "v*-*"
  workflow_dispatch:

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Extract release type from tag
        id: parse_tag
        run: |
          TAG='${{ github.ref_name }}'
          # TAG format: v1.0.0-stable, v1.0.0-alpha, etc.
          # Extract the type (last part after dash)
          TYPE=$(echo "$TAG" | grep -oE '[a-z]+$')
          echo "TYPE=$TYPE" >> $GITHUB_OUTPUT
          echo "Release type: $TYPE"

      - name: Build package
        run: |
          uv build
          echo "Built packages:"
          ls -lh dist/

      - name: Publish to PyPI (stable and post-release only)
        if: steps.parse_tag.outputs.TYPE == 'stable' || steps.parse_tag.outputs.TYPE == 'post'
        env:
          UV_PUBLISH_TOKEN: ${{ secrets.PYPI_API_TOKEN }}
        run: uv publish

      - name: Publish to TestPyPI (pre-release, except dev which will remain on GitHub only)
        if: >-
          steps.parse_tag.outputs.TYPE != 'stable'
          && steps.parse_tag.outputs.TYPE != 'post'
          && steps.parse_tag.outputs.TYPE != 'dev'
        env:
          UV_PUBLISH_TOKEN: ${{ secrets.TEST_PYPI_API_TOKEN }}
        run: uv publish --index testpypi
