name: 1) Create Release Tag

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  create-tag:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Get package version
        id: get_version
        run: |
          VERSION=$(uv version --short)
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Package version: $VERSION"

      - name: Derive Version Number
        id: derive_version_num
        run: |
          VERSION='${{ steps.get_version.outputs.VERSION }}'
          # Extract X.Y.Z (keeps dots, removes suffix like a1, b2, rc3, .post1, .dev1)
          VERSION_NUM=$(echo "$VERSION" | grep -oE '^[0-9]+\.[0-9]+\.[0-9]+')
          echo "VERSION_NUM=$VERSION_NUM" >> $GITHUB_OUTPUT
          echo "Derived version number: $VERSION_NUM"

      - name: Classify version
        id: check_version
        run: |
          VERSION='${{ steps.get_version.outputs.VERSION }}'

          TYPE=unknown

          if [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            TYPE=stable
          elif [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+a[0-9]+$ ]]; then
            TYPE=alpha
          elif [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+b[0-9]+$ ]]; then
            TYPE=beta
          elif [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+rc[0-9]+$ ]]; then
            TYPE=rc
          elif [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.post[0-9]+$ ]]; then
            TYPE=post
          elif [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.dev[0-9]+$ ]]; then
            TYPE=dev
          fi

          echo "TYPE=$TYPE" >> "$GITHUB_OUTPUT"
          echo "Version type: $TYPE"

      - name: Create and push tag
        if: steps.check_version.outputs.TYPE != 'unknown'
        run: |
          VERSION_NUM='${{ steps.derive_version_num.outputs.VERSION_NUM }}'
          TYPE='${{ steps.check_version.outputs.TYPE }}'
          TAG="v$VERSION_NUM-$TYPE"

          if git ls-remote --tags origin | grep -q "refs/tags/$TAG$"; then
            echo "Tag $TAG already exists."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "$TAG" -m "Release $TAG"
          git push origin "$TAG"
          echo "Created tag $TAG"
